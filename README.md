# üõ†Ô∏è Backend Marketplace - Node.js + Express + PostgreSQL + JWT

Este proyecto es un backend desarrollado con **Node.js** y **Express**, utilizando una base de datos **PostgreSQL** desplegada en **Render**. Est√° dise√±ado para gestionar m√∫ltiples comercios (tenants) y sus respectivos cat√°logos, productos y promociones con **autenticaci√≥n JWT**.

---

## üöÄ Scripts disponibles

```json
"scripts": {
  "dev": "nodemon src/app.js",
  "start": "node src/app.js",
  "init-db": "node src/config/db_init_model.js",
  "drop-db": "node src/config/db_exec_drop_tables.js"
}
```

- `npm run dev`: Levanta el servidor en modo desarrollo con **nodemon**.
- `npm start`: Ejecuta el servidor en producci√≥n.
- `npm run init-db`: Inicializa las tablas en la base de datos.
- `npm run drop-db`: Elimina todas las tablas de la base de datos.

---

## üîê Autenticaci√≥n JWT

Este proyecto implementa **autenticaci√≥n JWT completa** en todos los endpoints (excepto autenticaci√≥n y callbacks p√∫blicos). 

### Caracter√≠sticas:
- ‚úÖ **Token Bearer**: Todos los endpoints requieren `Authorization: Bearer <token>`
- ‚úÖ **Multi-tenant**: Usuarios aislados por tenant
- ‚úÖ **Roles**: Admin (acceso completo) y Operador (acceso limitado)
- ‚úÖ **Permisos granulares**: Control de acceso por comercio
- ‚úÖ **Refresh tokens**: Sistema de renovaci√≥n de tokens
- ‚úÖ **Autorizaci√≥n autom√°tica**: Los datos se filtran por tenant/usuario autom√°ticamente

---

## üì¶ Instalaci√≥n de dependencias

```bash
npm install
```

**Dependencias principales:**
- `dotenv`: Manejo de variables de entorno
- `cors`: Habilita peticiones cross-origin desde el frontend
- `morgan`: Middleware de logging
- `pg`: Cliente de PostgreSQL para Node.js
- `nodemon`: Recarga autom√°tica del servidor durante el desarrollo
- `multer`: Manejo de subida de archivos
- `cloudinary`: Servicio de almacenamiento de im√°genes en la nube
- `jsonwebtoken`: Manejo de tokens JWT para autenticaci√≥n
- `bcryptjs`: Hashing de contrase√±as

---

## üîê Variables de Entorno

El proyecto requiere las siguientes variables de entorno en un archivo `.env`:

```bash
# Base de datos
DATABASE_URL=postgres://user:password@host:port/database

# Cloudinary
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# JWT Secrets (generar con crypto.randomBytes(64).toString('hex'))
JWT_SECRET=your_jwt_secret_128_chars
JWT_REFRESH_SECRET=your_refresh_secret_128_chars

# Hub de Eventos
HUB_USERNAME=marketplace-service
HUB_PASSWORD=12345
```

---

## üîë Autenticaci√≥n JWT

Todos los endpoints (excepto autenticaci√≥n y callbacks) requieren un token JWT v√°lido en el header:

```bash
Authorization: Bearer <tu_jwt_token>
```

### Estructura del Token JWT:
```json
{
  "usuario_id": 1,
  "tenant_id": 1,
  "nombre": "Juan P√©rez",
  "email": "juan@ejemplo.com",
  "rol": "admin",
  "tenant_nombre": "Mi Negocio",
  "comercios_autorizados_id": [1, 2, 3]
}
```

---

## üìã API Endpoints

### üîê Autenticaci√≥n

#### POST /api/auth/login
**Descripci√≥n:** Iniciar sesi√≥n
**Autenticaci√≥n:** ‚ùå No requiere
**Body requerido:**
```json
{
  "email": "admin@ejemplo.com",
  "password": "tu_password"
}
```
**Respuesta exitosa:**
```json
{
  "message": "Login exitoso",
  "user": {
    "usuario_id": 1,
    "nombre": "Juan P√©rez",
    "email": "admin@ejemplo.com",
    "rol": "admin"
  },
  "tenant_id": 1,
  "tokens": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

#### POST /api/auth/register-tenant
**Descripci√≥n:** Crear nuevo tenant con usuario admin
**Autenticaci√≥n:** ‚ùå No requiere
**Body requerido:**
```json
{
  "nombre": "Mi Negocio",
  "razon_social": "Mi Negocio S.A.",
  "cuenta_bancaria": "1234567890",
  "email": "admin@ejemplo.com",
  "telefono": "1234567890",
  "calle": "Av. Corrientes",
  "numero": "1234",
  "ciudad": "Buenos Aires",
  "provincia": "CABA",
  "codigo_postal": "1043",
  "nombre_usuario": "Juan P√©rez",
  "password": "mi_password",
  "sitio_web": "https://miweb.com",
  "instagram": "@miweb"
}
```

#### POST /api/auth/register-internal
**Descripci√≥n:** Crear usuario interno (admins pueden hacer esto √∫nicamente)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body requerido:**
```json
{
  "nombre": "Mar√≠a Garc√≠a",
  "email": "maria@ejemplo.com",
  "password": "password123",
  "rol": "operador",
  "comercios_ids": [1, 2]
}
```

#### POST /api/auth/refresh
**Descripci√≥n:** Renovar tokens JWT
**Autenticaci√≥n:** ‚ùå No requiere
**Body requerido:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
}
```

#### GET /api/auth/profile
**Descripci√≥n:** Obtener perfil del usuario autenticado
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "success": true,
  "data": {
    "usuario_id": 1,
    "tenant_id": 1,
    "nombre": "Juan P√©rez",
    "email": "admin@ejemplo.com",
    "rol": "admin",
    "tenant": {
      "nombre": "Mi Negocio",
      "razon_social": "Mi Negocio S.A.",
      "estado": "activo"
    },
    "comercios": [
      {"comercio_id": 1, "nombre": "Sucursal Centro"},
      {"comercio_id": 2, "nombre": "Sucursal Norte"}
    ]
  }
}
```

---

### üè¢ Tenants

#### GET /api/tenants
**Descripci√≥n:** Obtener tenants (admin ve su propio tenant)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body:** ‚ùå No requiere
**Query params:** `page=1&size=10`
**Respuesta exitosa:**
```json
{
  "data": [
    {
      "tenant_id": 1,
      "nombre": "Mi Negocio",
      "razon_social": "Mi Negocio S.A.",
      "cuenta_bancaria": "1234567890",
      "email": "admin@ejemplo.com",
      "telefono": "1234567890",
      "calle": "Av. Corrientes",
      "numero": "1234",
      "ciudad": "Buenos Aires",
      "provincia": "CABA",
      "codigo_postal": "1043"
    }
  ],
  "pagination": {
    "totalItems": 1,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

#### POST /api/tenants
**Descripci√≥n:** Crear nuevo tenant
**Autenticaci√≥n:** ‚úÖ Requiere (Super Admin)
**Body requerido:**
```json
{
  "nombre": "Nuevo Negocio",
  "razon_social": "Nuevo Negocio S.A.",
  "cuenta_bancaria": "9876543210",
  "email": "nuevo@ejemplo.com",
  "telefono": "9876543210",
  "calle": "Av. Santa Fe",
  "numero": "5678",
  "ciudad": "Buenos Aires",
  "provincia": "CABA",
  "codigo_postal": "1425"
}
```

#### PATCH /api/tenants/:tenantId
**Descripci√≥n:** Actualizar tenant (solo el propio)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin del mismo tenant)
**Body:** Campos opcionales para actualizar
```json
{
  "nombre": "Nuevo Nombre",
  "telefono": "1111111111"
}
```

#### DELETE /api/tenants/:tenantId
**Descripci√≥n:** Eliminar tenant (solo el propio)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin del mismo tenant)
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "message": "Tenant eliminado",
  "tenant_id": 1
}
```

---

### üè™ Sellers (Comercios)

#### GET /api/sellers
**Descripci√≥n:** Obtener comercios del tenant O buscar cercanos
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Query params opcionales:**
- Sin params: Lista comercios del tenant
- `lat=-34.6037&lon=-58.3816`: Busca comercios cercanos (5km)
- `page=1&size=10`: Paginaci√≥n (solo para lista del tenant)

**Respuesta (lista del tenant):**
```json
{
  "success": true,
  "data": [
    {
      "comercio_id": 1,
      "tenant_id": 1,
      "nombre": "Sucursal Centro",
      "calle": "Av. Corrientes",
      "numero": "1234",
      "ciudad": "Buenos Aires",
      "provincia": "CABA",
      "codigo_postal": "1043",
      "lat": -34.6037,
      "lon": -58.3816,
      "horarios": [
        {
          "dia_semana": 1,
          "dia_nombre": "Lunes",
          "hora_apertura": "09:00",
          "hora_cierre": "18:00",
          "estado": "activo"
        }
      ]
    }
  ],
  "pagination": {
    "page": 1,
    "size": 10,
    "totalItems": 5,
    "totalPages": 1
  }
}
```

#### GET /api/sellers/:id
**Descripci√≥n:** Obtener comercio espec√≠fico
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "success": true,
  "data": {
    "comercio_id": 1,
    "tenant_id": 1,
    "nombre": "Sucursal Centro",
    "calle": "Av. Corrientes",
    "numero": "1234",
    "ciudad": "Buenos Aires",
    "horarios": [...]
  }
}
```

#### POST /api/sellers
**Descripci√≥n:** Crear nuevo comercio
**Autenticaci√≥n:** ‚úÖ Requiere
**Body requerido:**
```json
{
  "nombre": "Nueva Sucursal",
  "calle": "Av. Santa Fe",
  "numero": "5678",
  "ciudad": "Buenos Aires",
  "provincia": "CABA",
  "codigo_postal": "1425",
  "horarios": [
    {
      "dia_semana": 1,
      "hora_apertura": "09:00",
      "hora_cierre": "18:00"
    }
  ]
}
```

#### PATCH /api/sellers/:id
**Descripci√≥n:** Actualizar comercio
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body:** Campos opcionales para actualizar
```json
{
  "nombre": "Nuevo Nombre",
  "horarios": [
    {
      "dia_semana": 1,
      "hora_apertura": "08:00",
      "hora_cierre": "19:00"
    }
  ]
}
```

#### DELETE /api/sellers/:id
**Descripci√≥n:** Eliminar comercio
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body:** ‚ùå No requiere

---

### üì¶ Productos

#### GET /api/products
**Descripci√≥n:** Obtener productos del tenant
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
[
  {
    "producto_id": 1,
    "tenant_id": 1,
    "nombre_producto": "Pizza Margherita",
    "descripcion": "Pizza cl√°sica con tomate y mozzarella",
    "precio": 850.50,
    "categoria_id": 1,
    "categoria_nombre": "Pizzas",
    "imagenes": [
      {
        "imagen_id": 1,
        "url": "https://res.cloudinary.com/.../image.jpg",
        "descripcion": "Imagen principal"
      }
    ],
    "promociones": []
  }
]
```

#### GET /api/products/:productId
**Descripci√≥n:** Obtener producto espec√≠fico
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere

#### POST /api/products
**Descripci√≥n:** Crear nuevo producto
**Autenticaci√≥n:** ‚úÖ Requiere
**Body requerido (multipart/form-data):**
```json
{
  "nombre_producto": "Pizza Margherita",
  "descripcion": "Pizza cl√°sica con tomate y mozzarella",
  "precio": 850.50,
  "categoria_id": 1
}
```
**Files:** `imagenes` (m√°ximo 5 im√°genes)

#### PATCH /api/products/:productId
**Descripci√≥n:** Actualizar producto
**Autenticaci√≥n:** ‚úÖ Requiere (producto del mismo tenant)
**Body:** Campos opcionales para actualizar (multipart/form-data)

#### DELETE /api/products/:productId
**Descripci√≥n:** Eliminar producto
**Autenticaci√≥n:** ‚úÖ Requiere (producto del mismo tenant)
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "message": "Producto eliminado exitosamente",
  "deleted_product": {
    "tenant_id": 1,
    "producto_id": 1,
    "nombre_producto": "Pizza Margherita"
  }
}
```

#### GET /api/products/csv/template
**Descripci√≥n:** Obtener template CSV para carga masiva
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere

#### POST /api/products/csv/upload
**Descripci√≥n:** Subir CSV con productos (solo admins)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body:** File CSV
**Content-Type:** multipart/form-data

---

### üè™ Stock de Comercios

#### GET /api/sellers/:id/products
**Descripci√≥n:** Obtener productos con stock del comercio
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "success": true,
  "data": {
    "comercio": {
      "comercio_id": 1,
      "nombre": "Sucursal Centro",
      "tenant_id": 1
    },
    "productos": [
      {
        "producto_id": 1,
        "nombre_producto": "Pizza Margherita",
        "precio": 850.50,
        "cantidad_stock": 25,
        "imagenes": [...],
        "promociones": [...]
      }
    ]
  }
}
```

#### GET /api/sellers/:id/products/:productId/stock
**Descripci√≥n:** Obtener stock espec√≠fico de un producto
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body:** ‚ùå No requiere

#### PATCH /api/sellers/:id/products/:productId/stock
**Descripci√≥n:** Actualizar stock de un producto
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body requerido:**
```json
{
  "cantidad_stock": 30
}
```

---

### üè∑Ô∏è Categor√≠as

#### GET /api/categories
**Descripci√≥n:** Obtener categor√≠as con productos del tenant
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
[
  {
    "categoria_id": 1,
    "nombre": "Pizzas",
    "descripcion": "Pizzas artesanales",
    "fecha_creacion": "2024-01-15T10:30:00.000Z"
  },
  {
    "categoria_id": 2,
    "nombre": "Hamburguesas",
    "descripcion": "Hamburguesas gourmet",
    "fecha_creacion": "2024-01-15T10:35:00.000Z"
  }
]
```

#### GET /api/categories/:categoriaId
**Descripci√≥n:** Obtener categor√≠a espec√≠fica
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere

#### POST /api/categories
**Descripci√≥n:** Crear nueva categor√≠a (solo admins)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body requerido:**
```json
{
  "nombre": "Bebidas",
  "descripcion": "Bebidas fr√≠as y calientes"
}
```

#### PATCH /api/categories/:categoriaId
**Descripci√≥n:** Actualizar categor√≠a (solo admins con productos asociados)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body:** Campos opcionales para actualizar
```json
{
  "nombre": "Nuevo Nombre",
  "descripcion": "Nueva descripci√≥n"
}
```

#### DELETE /api/categories/:categoriaId
**Descripci√≥n:** Eliminar categor√≠a (solo admins sin productos asociados)
**Autenticaci√≥n:** ‚úÖ Requiere (Admin)
**Body:** ‚ùå No requiere

---

### üéØ Promociones

#### GET /api/promotions
**Descripci√≥n:** Obtener promociones del tenant
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
[
  {
    "promocion_id": 1,
    "nombre": "2x1 en Pizzas",
    "tipo_promocion": "porcentaje",
    "valor_descuento": 50.00,
    "fecha_inicio": "2024-01-15T00:00:00.000Z",
    "fecha_fin": "2024-01-31T23:59:59.000Z",
    "productos": [
      {
        "producto_id": 1,
        "nombre_producto": "Pizza Margherita",
        "precio": 850.50
      }
    ]
  }
]
```

#### POST /api/promotions
**Descripci√≥n:** Crear nueva promoci√≥n
**Autenticaci√≥n:** ‚úÖ Requiere
**Body requerido:**
```json
{
  "nombre": "2x1 en Pizzas",
  "tipo_promocion": "porcentaje",
  "valor_descuento": 50.00,
  "lista_productos": [1, 2, 3],
  "fecha_inicio": "2024-01-15T00:00:00.000Z",
  "fecha_fin": "2024-01-31T23:59:59.000Z"
}
```

#### PATCH /api/promotions/:promotionId
**Descripci√≥n:** Actualizar promoci√≥n
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** Campos opcionales para actualizar

#### DELETE /api/promotions/:promotionId
**Descripci√≥n:** Eliminar promoci√≥n
**Autenticaci√≥n:** ‚úÖ Requiere
**Body:** ‚ùå No requiere

---

### üìã √ìrdenes

#### GET /api/orders/:comercio_id
**Descripci√≥n:** Obtener √≥rdenes de un comercio
**Autenticaci√≥n:** ‚úÖ Requiere (acceso al comercio)
**Body:** ‚ùå No requiere
**Respuesta exitosa:**
```json
{
  "success": true,
  "data": [
    {
      "orden_id": 1,
      "tenant_id": 1,
      "comercio_id": 1,
      "cliente_nombre": "Juan P√©rez",
      "medios_pago": "fiat",
      "estado": "pendiente",
      "total": 1250.75,
      "direccion_entrega": "Av. Corrientes 1234, CABA",
      "fecha_creacion": "2024-01-15T14:30:00.000Z"
    }
  ]
}
```

---

### üîó Callbacks (Sin Autenticaci√≥n)

#### GET /callback
**Descripci√≥n:** Verificaci√≥n de suscripci√≥n del hub de eventos
**Autenticaci√≥n:** ‚ùå No requiere (endpoint p√∫blico)
**Body:** ‚ùå No requiere
**Query params:** `topic` y `challenge`

#### POST /callback
**Descripci√≥n:** Recepci√≥n de eventos del hub
**Autenticaci√≥n:** ‚ùå No requiere (endpoint p√∫blico)
**Body:** Estructura de evento
```json
{
  "event": "tipo.evento",
  "data": {...}
}
```

---

## üîí Autorizaci√≥n por Roles

### Admin
- Puede acceder a todos los recursos de su tenant
- Puede crear/modificar/eliminar categor√≠as y promociones
- Puede crear usuarios internos
- Puede gestionar todos los comercios de su tenant

### Operador
- Solo puede acceder a comercios asignados
- Puede gestionar productos y stock de sus comercios
- No puede crear/eliminar categor√≠as o promociones

---

## üö® C√≥digos de Error Comunes

- `401`: Token JWT faltante o inv√°lido
- `403`: Sin permisos para acceder al recurso
- `404`: Recurso no encontrado
- `400`: Datos inv√°lidos en el body
- `500`: Error interno del servidor

---

## üìÅ Estructura de carpetas

```bash
src/
‚îÇ
‚îú‚îÄ‚îÄ config/           # Configuraci√≥n general
‚îÇ   ‚îú‚îÄ‚îÄ db_connection.js
‚îÇ   ‚îú‚îÄ‚îÄ db_model.sql
‚îÇ   ‚îú‚îÄ‚îÄ multerConfig.js
‚îÇ   ‚îî‚îÄ‚îÄ csvMulterConfig.js
‚îÇ
‚îú‚îÄ‚îÄ controllers/      # Controladores con l√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ authController.js      # Autenticaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ tenantController.js
‚îÇ   ‚îú‚îÄ‚îÄ productController.js
‚îÇ   ‚îú‚îÄ‚îÄ sellerController.js
‚îÇ   ‚îú‚îÄ‚îÄ categoriesController.js
‚îÇ   ‚îú‚îÄ‚îÄ promotionsController.js
‚îÇ   ‚îú‚îÄ‚îÄ orderController.js
‚îÇ   ‚îî‚îÄ‚îÄ callbackController.js
‚îÇ
‚îú‚îÄ‚îÄ middlewares/      # Middlewares de autenticaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ authMiddleware.js      # JWT y validaciones
‚îÇ
‚îú‚îÄ‚îÄ models/           # Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ user.model.js
‚îÇ   ‚îú‚îÄ‚îÄ tenant.model.js
‚îÇ   ‚îú‚îÄ‚îÄ producto.model.js
‚îÇ   ‚îú‚îÄ‚îÄ seller.model.js
‚îÇ   ‚îú‚îÄ‚îÄ categoria.model.js
‚îÇ   ‚îú‚îÄ‚îÄ promocion.model.js
‚îÇ   ‚îî‚îÄ‚îÄ order.model.js
‚îÇ
‚îú‚îÄ‚îÄ routes/           # Rutas HTTP
‚îÇ   ‚îú‚îÄ‚îÄ authRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ tenantRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ productRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ sellerRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ categoriesRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ promotionsRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ orderRoutes.js
‚îÇ   ‚îî‚îÄ‚îÄ callbackRoutes.js
‚îÇ
‚îú‚îÄ‚îÄ services/         # Servicios externos
‚îÇ   ‚îú‚îÄ‚îÄ jwtService.js          # Manejo de tokens JWT
‚îÇ   ‚îú‚îÄ‚îÄ geocodingService.js
‚îÇ   ‚îú‚îÄ‚îÄ imageUploadService.js
‚îÇ   ‚îî‚îÄ‚îÄ timeServices.js
‚îÇ
‚îú‚îÄ‚îÄ events/           # Sistema de eventos
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ publishers/
‚îÇ   ‚îú‚îÄ‚îÄ subscribers/
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ
‚îú‚îÄ‚îÄ utils/           # Utilidades
‚îÇ   ‚îî‚îÄ‚îÄ formatters.js
‚îÇ
‚îî‚îÄ‚îÄ app.js             # Punto de entrada del servidor
```